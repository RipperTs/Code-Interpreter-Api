  # Code Interpreter API 🚀

[English](https://github.com/leezhuuuuu/Code-Interpreter-Api/blob/main/README_EN.md) | [中文](https://github.com/leezhuuuuu/Code-Interpreter-Api/blob/main/README.md)

## Overview 🌟

The Code Interpreter API is a project that combines a dispatch center and a sandbox environment, built on the Flask framework. It aims to provide a secure and reliable API interface for remotely running code and obtaining execution results. The project creatively integrates Docker container technology to ensure the safe and isolated execution of Python code. Additionally, it supports storing generated image data in a PostgreSQL database and accessing it through API endpoints, offering rich data processing and storage capabilities.

## Tech Stack 🛠️

- **Backend Framework**: Flask (Python)
- **Database**: PostgreSQL
- **Containerization**: Docker
- **ORM**: SQLAlchemy
- **Concurrency Handling**: threading, Queue
- **Authentication**: Bearer Token
- **External Requests**: requests
- **Code Isolation**: subprocess

## Features 🌈

- **Multi-language Support**: Currently primarily supports Python code execution.
- **Image Processing**: Supports converting image data generated by code into Base64 format and storing it in the database.
- **Docker Container Isolation**: Each code execution request runs in an independent Docker container, ensuring security and resource isolation.
- **PostgreSQL Database Integration**: Image data can be stored in the database and accessed via RESTful API.
- **Authentication**: Optional Bearer token authentication to ensure secure access.
- **Environment Variables**: Configurable via environment variables.
- **Error Handling**: Comprehensive error handling and timeout management.

## Operating Environment 🖥️

- Python 3.8 or higher
- Docker
- PostgreSQL

## Quick Start 🚀

### 1. Clone the Project

```bash
git clone https://github.com/leezhuuuuu/Code-Interpreter-Api.git
cd Code-Interpreter-Api
```

### 2. Install Dependencies

```bash
pip install -r requirements.txt
```

### 3. Configuration File

The project uses `config.yaml` as the configuration file. Ensure that the file contains the following configurations:

- **Domain**: Used for accessing stored images.
- **Docker Image**: Specifies the Docker image used to run the code.
- **Port Range**: Specifies the port range for Docker containers.
- **PostgreSQL Configuration**: Includes database name, username, password, host, and port.
- **Resource Limits**: Specifies memory and CPU limits for Docker containers.
- **Timeout**: Specifies the timeout for code execution.

### 4. Obtain Docker Image

Make sure Docker is installed. Then, you can choose one of the following two methods to obtain the Docker image:

#### Method 1: Build a Custom Image

Run `build.py`, which will automatically generate the `requirements.txt` file based on the configuration file and build a custom image. You can customize the container environment dependencies according to your needs:

```bash
python3 build.py
```

#### Method 2: Pull a Pre-built Image

If you do not want to build the image, you can directly pull a pre-built image from Docker Hub:

```bash
docker pull leezhuuu/code_interpreter:latest
```

### 5. Start the Project

Use the following command to start the project:

```bash
python3 center.py
```

This command will automatically start the Flask application and run it on the configured dispatch center port.

## User Guide 📖

### 1. Run Code

Run the specified code by accessing the `/runcode` endpoint via POST or GET requests. The request data should contain the following fields:

- **languageType**: The language type of the code (currently only supports Python).
- **variables**: Optional, variables passed to the code.
- **code**: The code to be executed.

### 2. Access Images

Access the image data stored in the database by GET requests to the `/image/<filename>` endpoint.

## API Endpoints 🌐

### `POST /runcode`

#### Request

```json
{
  "languageType": "python",
  "variables": {},
  "code": "print('Hello, World!')"
}
```

#### Response

```json
{
  "output": "Hello, World!\n"
}
```

### `GET /runcode`

#### Request

```
/runcode?languageType=python&variables={}&code=print('Hello, World!')
```

#### Response

```json
{
  "output": "Hello, World!\n"
}
```

## Error Handling 🚨

The application returns appropriate HTTP status codes and error messages for different scenarios:

- **400 Bad Request**: Invalid JSON or parameters.
- **401 Unauthorized**: Missing or invalid token.
- **405 Method Not Allowed**: Invalid HTTP method.
- **504 Gateway Timeout**: Request timed out.

## Docker Integration 🐳

The application uses Docker to run code in isolated environments. You can choose to build a custom image or pull a pre-built image.

## PostgreSQL Integration 🐘

Image data generated during code execution is stored in the PostgreSQL database. Database connection details are configured in the `config.yaml` file.

## Concurrency Management 🔄

The application uses threading to handle multiple concurrent requests and uses a semaphore to control the number of concurrent requests.

## Testing 🧪

### Concurrency Testing

The application includes a concurrency testing script `concurrent_test.py`, which can be run to verify concurrency functionality:

```bash
python3 concurrent_test.py
```

## License 📄

This project is based on the GNU License. See the `LICENSE` file for details.

## Contribution 🤝

Contributions are welcome! Please submit issues or pull requests.

## Author ✍️

- leezhuuuuu

## Acknowledgments 🙏

- Flask
- Docker
- PostgreSQL
- SQLAlchemy

## GitHub Star History

<p align="center">
  <a href="https://star-history.com/#leezhuuuuu/Code-Interpreter-Api&Date">
    <img 
      alt="Star History Chart" 
      src="https://api.star-history.com/svg?repos=leezhuuuuu/Code-Interpreter-Api&type=Date" 
      style="max-width:100%;height:auto;"
    />
  </a>
</p>
